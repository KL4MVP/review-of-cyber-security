# TCP/IP协议攻防复习

## 1. TCP/IP协议层

<img src="./screenshot/截屏2020-04-22 上午10.22.26.png" alt="截屏2020-04-22 上午10.22.26.png"/>

##  2. 常见攻击方式

<img src="./screenshot/截屏2020-04-22 上午10.29.48.png" alt="截屏2020-04-22 上午10.29.48.png"/>

## 3. TCP/IP协议常见缺陷

<img src="./screenshot/截屏2020-04-22 上午10.32.36.png" alt="截屏2020-04-22 上午10.32.36.png"/>

## 4. 各类攻击详解

### 4.1 IP源地址欺骗

原理：IP协议在设计时只使用数据包中的目标地址进行路由转发，而不对源地址进行真实性的验 证。攻击者则会修改IP协议包头，使其包含一个不同的虚假IP地址，而接收到欺骗数据包的计算机则会向假冒的源地址发回响应包。Syn flood是建立在ip源地址欺骗上的攻击。

工具：netwox 52     netwox 76

<img src="./screenshot/截屏2020-04-22 上午10.48.46.png" alt="截屏2020-04-22 上午10.48.46.png"/>

防御手段：

- IP地址欺骗的防御可在网关或防火墙中进行源IP地址过滤，即禁止源地址非本网段地址的 数据包发出，从而从源头屏蔽伪造IP源地址的的数据包。
- 也可以采用基于加密算法的技术来进行身份认证，代替基于IP的信任策略。

### 4.2 ARP欺骗

ARP协议工作原理：

<img src="./screenshot/截屏2020-04-22 上午11.04.20.png" alt="截屏2020-04-22 上午11.04.20.png"/>

ARP欺骗：发送伪造ARP消息，对特定IP所对应的MAC地址进行假冒欺骗，从而达到恶意目的。ARP欺骗攻击的根源在于ARP协议在设计时认为局域网内部的所有用户都是可信的，当攻击者渗透进入内网后，通过向局域网内节点缓存中注入伪造的IP/MAC映射关系，从而进行欺骗，成为局域网内 的中间人节点，即可以监听并进一步篡改数据包。

工具：ettercap

防御手段：

- 静态绑定关键主机的IP地址与MAC地址映射关系

  > 网关/关键服务器
  >  "arp -s IP地址 MAC地址 类型"

- 使用相应的ARP防范工具（如ARP防火墙）
- 使用VLAN虚拟子网细分网络拓扑
- 加密传输数据以降低ARP欺骗攻击危害后果

### 4.3 ICMP路由重定向攻击

ICMP控制报文协议：它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。

攻击原理：ICMP路由重定向攻击(ICMPRedirectAttack)是指攻击者伪装成路由器发送虚假的ICMP路由路径控制报 文，使得受害主机选择攻击者指定的路由路径，从而进行嗅探或假冒攻击的一种技术。

<img src="./screenshot/截屏2020-04-22 下午2.24.53.png" alt="截屏2020-04-22 下午2.24.53.png"/>

工具：netwox 86

防御手段：

- 根据类型过滤一些ICMP数据包
- 设置防火墙过滤
- 对于ICMP重定向报文判断是否来自本地路由器

### 4.4 TCP协议RST攻击

TCP RST：TCP协议头部有一个标志位称为RST位，正常的数据包中该位为0，一旦该位设置为1，则接收该数据包的主机将立即断开TCP会话。

攻击原理：TCPReset攻击中，攻击者可以伪造TCP连接其中的一方给另一方发送带有RST位的包来断开TCP连接，但是要确保这个数据包的源IP地址、源端口号、目的IP地址、目的端口号、序列号等特征符合 已有TCP连接的特征，这就要求攻击者要能够监视通信双方之间的TCP连接。属于拒绝服务攻击。

工具：netwox 78

防御手段：

- RST是TCP报头的标志位，因此只要防火墙过滤带RST位的数据包即可防御。

### 4.5 TCP会话劫持攻击

会话劫持：(Session Hijack)是一种结合了嗅探以及欺骗技术在内的攻击手段。广义上说，会话劫持就是在一次 正常的通信过程中，黑客作为第三方参与到其中，或者是在数据流(例如基于TCP的会话)里注射额外的信息， 或者是将双方的通信模式暗中改变，即从直接联系变成有黑客联系。

TCP会话劫持：目标是劫持通信双方已建立的TCP会话 连接，假冒其中一方(通常是客户端)的身份，与 另一方进行进一步通信。

<img src="./screenshot/截屏2020-04-22 下午2.42.25.png" alt="截屏2020-04-22 下午2.42.25.png"/>

工具：ettercap

防御手段：

- 避免攻击者成为通信双方的中间人
- TCP会话加密(IPsec协议)，避免了攻击者在得到传输层的端口及序列号等关键信息。
- 防火墙配置，限制尽可能少量的外部许可连接的IP地址。
- ACK风暴:ACK包的数量明显增加。由于TCP通信需要提供两段序列号以保证连接同步和安全通信，如果双方序列号不同，会导致ACK风暴（当会话双方接收到一个不期望的数据包后，就会用自己期望的序列号返回ACK包；而在另一端，这个数据包也不是所期望的，就会再次以自己期望的序列号返回ACK包……于是，就这样来回往返，形成了恶性循环，最终导致ACK风暴）

### 4.6 TCP SYN FLOOD

原理：SYN FLOOD属于拒绝服务攻击( Denial of Service )的一种。主要是利用TCP三次握手过 程中的缺陷，向目标主机发送大量的伪造源地址的SYN连接请求，消耗目标主机的连接队列资源， 从而不能够为正常用户提供服务。

TCP三次握手流程：

<img src="./screenshot/截屏2020-04-22 下午3.51.34.png" alt="截屏2020-04-22 下午3.51.34" style="zoom:67%;" />

攻击流程：攻击者向被攻击者发起大量的SYN包(第一次握手包)， 并且伪装源IP地址。被攻击者会发送SYN-ACK(第二次 握手包)到假造的IP地址，因此永不可能收到ACK(第三 次握手包)。这样被攻击者将会等待ACK(第三次握手包) 的达到，从而占用内存和CPU的负载。通常把没有完全建 立起来的连接称为半开连接，大量半开连接的存在将使得 正常用户无法和被攻击者建立正常的TCP连接，从而无法提供正常的服务。

工具：netwox 76

防御手段：

- Syn flood属于dos攻击的一种，基于ip欺骗原理实现的，所以可以通过设置防火墙 从网络层防御。

- linux中使用syn cookie来防御synflood，首先查看参数值 

  ```shell
  cat /proc/sys/net/ipv4/tcp_syncookies 
  ```

  结果为1即为开启，结果为0即未打开,通过此命令进行参数修改: 

  ```shell
  echo 1 > /proc/sys/net/ipv4/tcp_syncookies
  ```

### 4.7 UDP FLOOD

攻击原理：由于UDP协议的无状态不可靠的天然特性，UDP Flood拒绝服务攻击的原理非常简单，即通过 向目标主机和网络发送大量的UDP数据包，造成目标主机显著的计算负载提升，或者目标网络的 网络拥塞，从而使得目标主机和网络陷入不可用的状态，造成拒绝服务攻击。

工具：hping3

防御手段：

- UDP是无状态连接协议，常用于僵尸网络的DDOS攻击，比起TCP来说更难防御。
- 通过设置防火墙，对UDP包的IP，端口，速率可针对性的防御udp flood。
- udp flood除了消耗受害者资源，也会消耗大量攻击者资源。

### 4.8 DNS欺骗攻击

DNS：因特网上作为域名和IP地址相互映射的一个分布式数据库， 能够使用户更方便的访问互联网，而不用记住IP地址。DNS协议运行在UDP协议之上，使用端口号53，DNS 并不包含任何认证机制，因此第三方可以对DNS数据包进行伪造。

攻击原理：

工具：ettercap

防御手段：

- 静态绑定DNS/IP映射可以有效防止DNS欺骗。

- 目前互联网中主流方法是采用DNSSec，其基于公钥体制的签名验证机制可实现DNS消

  息身份认证和完整性保护。
